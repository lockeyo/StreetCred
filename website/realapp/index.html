<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>StreetCred</title>

    <!-- Bootstrap core CSS -->
    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom fonts for this template -->
    <link rel="stylesheet" href="../vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../vendor/simple-line-icons/css/simple-line-icons.css">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">

    <!-- Plugin CSS -->
    <link rel="stylesheet" href="../device-mockups/device-mockups.min.css">

    <!-- Custom styles for this template -->
    <link href="../css/new-age.css" rel="stylesheet">

    <style type="text/css">
    .challenge-image {
        width: auto;
        height: 40px;
    }

    .name {
        margin: 0;
        text-align: center;
        width: 100%;
    }

    .join-button {
        width: 150px;
    }

    .challenge-list-item {
        text-align: center;
    }

    #challenges {
        height: 100%;
    }

    .circle {
        box-shadow: 0 0 0 1pt black;
        width: 24px;
        height: 24px;
        border-radius: 200px;
        color: white;
        margin-left: 20px;
    }

    .big {
        width: 54px;
        height: 54px;
        font-size: 2.5em;
    }

    .filled {
        background-color: green;
    }

    .streak-box {
        width: 100%;
        background-color: lightgrey;
    }

    </style>

  </script>

  <style type="text/css">
    body {
      font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
      font-weight: 300;
    }
    #result {
      background-color: red;
      padding: 20px;
      color: white;
      font-weight: bold;
    }
    table {
      color: #333;
      border-collapse:
      collapse; border-spacing: 0;
    }

    td, th {
        border: 1px solid transparent;
        height: 30px;
        width: 100px;
        transition: all 0.1s;
    }

    td {
      height: 25px;
    }

    #body {
      display: none;
    }

    th {
        background: #DFDFDF;
        font-weight: bold;
    }

    td {
        background: #FAFAFA;
        text-align: center;
    }

    .footer {
      color: #777;
    }
    .footer > a {
      color: #449;
    }
    </style>

    <style type="text/css">
      .hide{
        display: none;
      }

      #timeYouWalked{
          font-size: 30px;
          text-align: center;
      }

    </style>

  </head>

  <body id="body">


    <section id="challenges" class="container-fluid">

      <header class="titles d-flex justify-content-center align-items-center">
          <h4>Current Challenge</h4>
      </header>

      <div style="border: 1px solid #000; padding: 20px; margin: 30px 0;">
        <header class="titles d-flex justify-content-center align-items-center">
          <h5>Walk to work</h5>
        </header>

        <div id="timeYouWalked"></div>
        <h3 style="text-align: center;">Seconds to go</h3>

        <h5 id="chances" style="text-align: center;">Chances are, you are</h5>
        <div id="result">
        </div>
      </div>

      <!-- Hide -->
      <div style="display: none;">
      <!-- Get the users E-Mail Adress -->

        <h3>What's the user doing?</h3>
        <h4>Motion</h4>
        <table>
          <tr><td>X</td><td id="motionX">0</td></tr>
          <tr><td>Y</td><td id="motionY">0</td></tr>
          <tr><td>Z</td><td id="motionZ">0</td></tr>
          <tr><td>Overall</td><td id="motionOveral">0</td></tr>
        </table>

        <h4>Orientation</h4>
        <table>
          <tr><td>X</td><td id="orientationX">0</td></tr>
          <tr><td>Y</td><td id="orientationY">0</td></tr>
          <tr><td>Z</td><td id="orientationZ">0</td></tr>
        </table>
      </div>
      <!-- Hide -->

      <header class="titles d-flex justify-content-center align-items-center">
          <h4>Daily stats</h4>
      </header>


      <div id="container" style="width: 100%;">
    		<canvas id="canvas"></canvas>
    	</div>


      <header class="titles d-flex justify-content-center align-items-center">
          <h4>Mobility suggestions</h4>
      </header>
      <div id="content">
          <ul id="challenge-list" class="list-group">
              <li class="list-group-item flex-wrap challenge-list-item">
                  <div class="d-flex align-items-center">
                      <img class="challenge-image" src="./assets/bcg.png">
                      <p class="name">Use the new Uber Shared Van Service</p>
                  </div>
                  <button class="join-button button">Go to the Uber app</button>
              </li>
              <li class="list-group-item flex-wrap challenge-list-item">
                  <div class="d-flex align-items-center">
                      <img class="challenge-image" src="./assets/beach.png">
                      <p class="name">Use the public bus today and get 10% offf</p>
                  </div>
                  <button class="join-button button">Go to LA public transport</button>
              </li>
              <li class="list-group-item flex-wrap challenge-list-item">
                  <div class="d-flex align-items-center">
                      <img class="challenge-image" src="./assets/la.png">
                      <p class="name">Use the new E-Scooter</p>
                  </div>
                  <button class="join-button button">Use E-Scooter for free</button>
              </li>
          </ul>
      </div>


    </section>

    <script type="text/javascript" src="https://cdnjs.com/libraries/Chart.js"></script>

    <script type="text/javascript">
    'use strict';

window.chartColors = {
red: 'rgb(255, 99, 132)',
orange: 'rgb(255, 159, 64)',
yellow: 'rgb(255, 205, 86)',
green: 'rgb(75, 192, 192)',
blue: 'rgb(54, 162, 235)',
purple: 'rgb(153, 102, 255)',
grey: 'rgb(201, 203, 207)'
};

(function(global) {
var Months = [
  'January',
  'February',
  'March',
  'April',
  'May',
  'June',
  'July',
  'August',
  'September',
  'October',
  'November',
  'December'
];

var COLORS = [
  '#4dc9f6',
  '#f67019',
  '#f53794',
  '#537bc4',
  '#acc236',
  '#166a8f',
  '#00a950',
  '#58595b',
  '#8549ba'
];

var Samples = global.Samples || (global.Samples = {});
var Color = global.Color;

Samples.utils = {
  // Adapted from http://indiegamr.com/generate-repeatable-random-numbers-in-js/
  srand: function(seed) {
    this._seed = seed;
  },

  rand: function(min, max) {
    var seed = this._seed;
    min = min === undefined ? 0 : min;
    max = max === undefined ? 1 : max;
    this._seed = (seed * 9301 + 49297) % 233280;
    return min + (this._seed / 233280) * (max - min);
  },

  numbers: function(config) {
    var cfg = config || {};
    var min = cfg.min || 0;
    var max = cfg.max || 1;
    var from = cfg.from || [];
    var count = cfg.count || 8;
    var decimals = cfg.decimals || 8;
    var continuity = cfg.continuity || 1;
    var dfactor = Math.pow(10, decimals) || 0;
    var data = [];
    var i, value;

    for (i = 0; i < count; ++i) {
      value = (from[i] || 0) + this.rand(min, max);
      if (this.rand() <= continuity) {
        data.push(Math.round(dfactor * value) / dfactor);
      } else {
        data.push(null);
      }
    }

    return data;
  },

  labels: function(config) {
    var cfg = config || {};
    var min = cfg.min || 0;
    var max = cfg.max || 100;
    var count = cfg.count || 8;
    var step = (max - min) / count;
    var decimals = cfg.decimals || 8;
    var dfactor = Math.pow(10, decimals) || 0;
    var prefix = cfg.prefix || '';
    var values = [];
    var i;

    for (i = min; i < max; i += step) {
      values.push(prefix + Math.round(dfactor * i) / dfactor);
    }

    return values;
  },

  months: function(config) {
    var cfg = config || {};
    var count = cfg.count || 12;
    var section = cfg.section;
    var values = [];
    var i, value;

    for (i = 0; i < count; ++i) {
      value = Months[Math.ceil(i) % 12];
      values.push(value.substring(0, section));
    }

    return values;
  },

  color: function(index) {
    return COLORS[index % COLORS.length];
  },

  transparentize: function(color, opacity) {
    var alpha = opacity === undefined ? 0.5 : 1 - opacity;
    return Color(color).alpha(alpha).rgbString();
  }
};

// DEPRECATED
window.randomScalingFactor = function() {
  return Math.round(Samples.utils.rand(-100, 100));
};

// INITIALIZATION

Samples.utils.srand(Date.now());

// Google Analytics
/* eslint-disable */
if (document.location.hostname.match(/^(www\.)?chartjs\.org$/)) {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-28909194-3', 'auto');
  ga('send', 'pageview');
}
/* eslint-enable */

}(this));

    </script>

<script>
  var MONTHS = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  var color = Chart.helpers.color;
  var horizontalBarChartData = {
    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
    datasets: [{
      label: 'Dataset 1',
      backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
      borderColor: window.chartColors.red,
      borderWidth: 1,
      data: [
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor()
      ]
    }, {
      label: 'Dataset 2',
      backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
      borderColor: window.chartColors.blue,
      data: [
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor(),
        randomScalingFactor()
      ]
    }]

  };

  window.onload = function() {
    var ctx = document.getElementById('canvas').getContext('2d');
    window.myHorizontalBar = new Chart(ctx, {
      type: 'horizontalBar',
      data: horizontalBarChartData,
      options: {
        // Elements options apply to all of the options unless overridden in a dataset
        // In this case, we are setting the border of each horizontal bar to be 2px wide
        elements: {
          rectangle: {
            borderWidth: 2,
          }
        },
        responsive: true,
        legend: {
          position: 'right',
        },
        title: {
          display: true,
          text: 'Chart.js Horizontal Bar Chart'
        }
      }
    });

  };

  document.getElementById('randomizeData').addEventListener('click', function() {
    var zero = Math.random() < 0.2 ? true : false;
    horizontalBarChartData.datasets.forEach(function(dataset) {
      dataset.data = dataset.data.map(function() {
        return zero ? 0.0 : randomScalingFactor();
      });

    });
    window.myHorizontalBar.update();
  });

  var colorNames = Object.keys(window.chartColors);

  document.getElementById('addDataset').addEventListener('click', function() {
    var colorName = colorNames[horizontalBarChartData.datasets.length % colorNames.length];
    var dsColor = window.chartColors[colorName];
    var newDataset = {
      label: 'Dataset ' + horizontalBarChartData.datasets.length,
      backgroundColor: color(dsColor).alpha(0.5).rgbString(),
      borderColor: dsColor,
      data: []
    };

    for (var index = 0; index < horizontalBarChartData.labels.length; ++index) {
      newDataset.data.push(randomScalingFactor());
    }

    horizontalBarChartData.datasets.push(newDataset);
    window.myHorizontalBar.update();
  });

  document.getElementById('addData').addEventListener('click', function() {
    if (horizontalBarChartData.datasets.length > 0) {
      var month = MONTHS[horizontalBarChartData.labels.length % MONTHS.length];
      horizontalBarChartData.labels.push(month);

      for (var index = 0; index < horizontalBarChartData.datasets.length; ++index) {
        horizontalBarChartData.datasets[index].data.push(randomScalingFactor());
      }

      window.myHorizontalBar.update();
    }
  });

  document.getElementById('removeDataset').addEventListener('click', function() {
    horizontalBarChartData.datasets.splice(0, 1);
    window.myHorizontalBar.update();
  });

  document.getElementById('removeData').addEventListener('click', function() {
    horizontalBarChartData.labels.splice(-1, 1); // remove the label first

    horizontalBarChartData.datasets.forEach(function(dataset) {
      dataset.data.pop();
    });

    window.myHorizontalBar.update();
  });
</script>

    <script type="text/javascript">
      // via https://stackoverflow.com/questions/9050345/
      if (!Array.prototype.last) {
        Array.prototype.last = function() {
          return this[this.length - 1];
      }

      // Artifical loading for a bit to make sure the gyro loads the data first
      setTimeout(function() {
        document.getElementById("body").style.display = 'block'
      }, 500)

      var historicMotion = {
        "x": [],
        "y": [],
        "z": []
      }
      var historicOrientation = {
        "x": [],
        "y": [],
        "z": []
      }

      if(localStorage.getItem("timeYouWalked") == undefined){
        var timeYouWalked = 600;
      }
      else{
        var timeYouWalked = localStorage.getItem("timeYouWalked");
      };

      var statusMessage = null;

      setInterval(function() {
        // every second ask fo the status
        if (statusMessage == "walking. Keep it up."){
            timeYouWalked -= 1;
            document.getElementById("result").style.backgroundColor = "green";
            localStorage.timeYouWalked = timeYouWalked;
        }
        else{
          document.getElementById("result").style.backgroundColor = "red";
        }

        if(timeYouWalked <= 0){
            window.location.replace("http://streetcred.menux.org/testapp/winner.html");
        }
      }, 1000);

      function setStatus(status) {
        statusMessage = status;
        document.getElementById("result").textContent = status
      }

      function updateStatus() {
        document.getElementById("timeYouWalked").textContent = timeYouWalked

        let movement = mostRecentMovementOverall(75)
        document.getElementById("motionOveral").textContent = movement.toFixed(2)

        // Below some stupid, very basic code to guess what the user is doing
        // As described in the README, this is just a proof of concept
        if (historicOrientation["z"].last() > 70 || historicOrientation["z"].last() < -70) {
          setStatus("lying in bed sideways, or taking a landscape picture")
        } else if (historicOrientation["y"].last() > 160 || historicOrientation["y"].last() < -160) {
          setStatus("lying on your back, with your phone up")
        } else if (historicOrientation["y"].last() >= 30 && historicOrientation["y"].last() < 70) {
          if (movement > 18) {
            setStatus("walking. Keep gooing.")
          } else {
            setStatus("using your phone, sitting or standing")
          }
        } else if (historicOrientation["y"].last() >= 70 && historicOrientation["y"].last() < 95) {
          if (movement > 18) {
            setStatus("walking. Keep it up.")
          } else {
            setStatus("taking a picture")
          }
        } else if (historicOrientation["y"].last() >= 95 && historicOrientation["y"].last() < 120) {
          setStatus("taking a selfie")
        } else if (Math.round(historicOrientation["z"].last()) == 0 && Math.round(historicOrientation["y"].last()) == 0) {
          setStatus("using the phone on a table")
        } else {
          if (movement > 18) {
            setStatus("walking. Keep it up.")
          } else {
            setStatus("using your phone, sitting or standing")
          }
        }
      }

      function mostRecentMovementOverall(numberOfHistoricPoints) {
        return (mostRecentMovement(historicMotion["x"], numberOfHistoricPoints, true) +
                mostRecentMovement(historicMotion["y"], numberOfHistoricPoints, true) +
                mostRecentMovement(historicMotion["z"], numberOfHistoricPoints, true)) / 3.0
      }

      // numberOfHistoricPoints: 100 is about 3 seconds
      function mostRecentMovement(array, numberOfHistoricPoints, removeNegatives) {
        if (array.length > numberOfHistoricPoints) {
          totalSum = 0
          for (var toCount = 0; toCount < numberOfHistoricPoints; toCount++) {
            currentElement = array[array.length - toCount - 1]
            currentElement *= (1 - toCount / numberOfHistoricPoints) // weight the most recent data more
            if (currentElement < 0 && removeNegatives) currentElement = currentElement * -1
            if (currentElement > 0.1 || currentElement < -0.1) totalSum += currentElement
          }
          return totalSum * 100 / numberOfHistoricPoints
        }
        return 0 // not enough data yet
      }

      var isMobile = navigator.userAgent.match(/(iPhone|iPod|iPad|Android)/);
      if (isMobile != null) {
        window.addEventListener("devicemotion", motion, false);

        function motion(event) {
          document.getElementById("motionX").textContent = (mostRecentMovement(historicMotion["x"], 150, false)).toFixed(2)
          document.getElementById("motionY").textContent = (mostRecentMovement(historicMotion["y"], 150, false)).toFixed(2)
          document.getElementById("motionZ").textContent = (mostRecentMovement(historicMotion["z"], 150, false)).toFixed(2)

          historicMotion["x"].push(event.acceleration.x)
          historicMotion["y"].push(event.acceleration.y)
          historicMotion["z"].push(event.acceleration.z)
        }

        window.addEventListener("deviceorientation", orientation, false);

        function orientation(event) {
          document.getElementById("orientationX").textContent = Math.round(event.alpha)
          document.getElementById("orientationY").textContent = Math.round(event.beta)
          document.getElementById("orientationZ").textContent = Math.round(event.gamma)

          historicOrientation["x"].push(event.alpha)
          historicOrientation["y"].push(event.beta)
          historicOrientation["z"].push(event.gamma)
        }
        setInterval(updateStatus, 100)
      } else {
        setStatus("Please open this site on your smartphone")
        document.getElementById("chances").style.display = 'none';
      }
    };
    </script>

  </body>

</html>
